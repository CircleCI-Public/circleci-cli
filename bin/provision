#!/usr/bin/env bash

apt_update() {
  if [[ -z $apt_updated ]]
  then
    apt-get -qq update &&
      apt_updated=true || exit
  fi
}

if ! sudo -u vagrant docker run --rm hello-world
then
  apt_update &&
    apt-get -qq install apt-transport-https ca-certificates curl software-properties-common &&
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | apt-key add - &&
    add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable" &&
    apt-get -qq update &&
    apt-get -qq install docker-ce &&
    usermod -aG docker vagrant &&
    sudo -u vagrant docker run --rm hello-world ||
      exit
fi

if ! docker-compose --version
then
  curl --silent --show-error --fail --location \
       "https://github.com/docker/compose/releases/download/1.27.4/docker-compose-$(uname -s)-$(uname -m)" \
       -o /usr/local/bin/docker-compose &&
    chmod +x /usr/local/bin/docker-compose &&
    docker-compose --version ||
      exit
fi

if ! grep '^cd /vagrant$' ~vagrant/.bashrc
then
  sudo -u vagrant <<<'cd /vagrant' tee -a ~vagrant/.bashrc ||
    exit
fi

if ! grep '^HISTFILE=/vagrant/bash_history$' ~vagrant/.bashrc
then
  sudo -u vagrant tee -a <<<'HISTFILE=/vagrant/bash_history' ~vagrant/.bashrc ||
    exit
fi
